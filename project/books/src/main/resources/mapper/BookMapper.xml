<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ouranservice.DAO.BookDAO">

    <!-- 查看简略版本信息 -->
    <resultMap id="briefInfo" type="com.ouranservice.entity.Book">
        <id property="bookId" column="book_Id"/>                                <!-- Id -->
        <result property="bookName" column="book_Name"/>                        <!-- 书名 -->
        <result property="bookWriter" column="book_Writer"/>                    <!-- 作者 -->
        <result property="bookPublishTime" column="book_Publish_Time"/>         <!-- 出版时间 -->
        <result property="bookPublishArea" column="book_Publish_Area"/>         <!-- 出版区域 -->
        <result property="bookPic" column="book_Pic"/>                          <!-- 封面 -->
        <result property="bookIntroduction" column="book_Introduction"/>        <!-- 简介 -->
        <result property="bookStar" column="book_Star"/>                        <!-- 评分 -->
        <result property="bookDownAddress" column="book_Down_Address"/>         <!-- 下载地址 -->
        <result property="bookLikeCount" column="book_Like_Count"/>             <!-- 点赞数 -->
        <!-- 获取书籍类型信息 -->
        <collection property="bookTypes"
                    column="bookId=book_Id"
                    ofType="com.ouranservice.entity.BookTypes"
                    select="com.ouranservice.DAO.BookTypeDAO.getTypesByBookId">
            <result property="typeId" column="typeId"/>
            <result property="typeName" column="typeName"/>
        </collection>
    </resultMap>

    <!-- 查看详细版本信息 -->
    <resultMap id="detailInfo" type="com.ouranservice.entity.Book">
        <id property="bookId" column="book_Id"/>                                <!-- Id -->
        <result property="bookName" column="book_Name"/>                        <!-- 书名 -->
        <result property="bookWriter" column="book_Writer"/>                    <!-- 作者 -->
        <result property="bookPublishTime" column="book_Publish_Time"/>         <!-- 出版时间 -->
        <result property="bookPublishArea" column="book_Publish_Area"/>         <!-- 出版区域 -->
        <result property="bookPic" column="book_Pic"/>                          <!-- 封面 -->
        <result property="bookIntroduction" column="book_Introduction"/>        <!-- 简介 -->
        <result property="bookStar" column="book_Star"/>                        <!-- 评分 -->
        <result property="bookDownAddress" column="book_Down_Address"/>         <!-- 下载地址 -->
        <result property="bookLikeCount" column="book_Like_Count"/>             <!-- 点赞数 -->
        <!-- 获取评论信息 -->
        <collection property="bookComments"
                    column="bookId=book_Id"
                    ofType="com.ouranservice.entity.BookComment"
                    select="com.ouranservice.DAO.BookCommentDAO.getCommentByBookId">
            <id property="commentId"/>
            <result property="bookId" column="bookId=book_Id"/>
            <result property="userId" column="userId"/>
            <result property="detail" column="detail"/>
            <result property="commentLikeCount" column="commentLikeCount"/>
        </collection>
        <!-- 获取书籍类型信息 -->
        <collection property="bookTypes"
                    column="bookId=book_Id"
                    ofType="com.ouranservice.entity.BookTypes"
                    select="com.ouranservice.DAO.BookTypeDAO.getTypesByBookId">
            <result property="typeId" column="typeId"/>
            <result property="typeName" column="typeName"/>
        </collection>
    </resultMap>

    <!-- 查询全部书籍 -->
    <select id="getAllBooks" resultMap="briefInfo">
        select * from book LIMIT #{pageNumber},10
    </select>

    <!-- 根据bookId获取简略信息 -->
    <select id="getBriefById" resultMap="briefInfo">
        select * from book where book_Id = #{bookId}
    </select>

    <!-- 根据bookId获取详细信息 -->
    <select id="getDetailById" resultMap="detailInfo">
        select * from book where book_Id = #{bookId}
    </select>

    <!-- 根据typeId查询对应所有book -->
    <select id="getBookByTypeId" resultType="com.ouranservice.entity.Book">
        select
            b.book_id,
            b.book_name,
            b.book_writer,
            b.book_Publish_Time,
            b.book_Pic,
            b.book_Introduction,
            b.book_Like_Count
        from
            Book_To_Type btt, Book b
        where
            btt.type_id = #{typeId} and b.book_id = btt.book_id

    </select>

    <!-- 根据分类查询对应所有book -->
    <select id="getBookByRequest" resultMap="briefInfo">
        select * from
            Book b
            <if test="typeId != -1">
                ,Book_To_Type btt
            </if>
        <where>
            <if test="typeId != -1">
                btt.type_id = #{typeId} and b.book_id = btt.book_id
            </if>
            <if test="area != null and area != ''">
                and b.book_publish_area = #{area}
            </if>
            <if test="startTime != null and startTime != ''">
                and b.book_publish_time between #{startTime} and #{endTime}
            </if>
        </where>
        LIMIT #{pageNumber},10
    </select>

</mapper>